<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pas Foto Pro - Unit-01 Interface</title>
    <!-- AI Face API Library -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <!-- JSZip for batch downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;600;700&family=Share+Tech+Mono&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --eva-purple: #2d1b4d;
            --eva-purple-bright: #7a1fa2;
            --eva-neon-green: #44ff00;
            --eva-neon-green-glow: rgba(68, 255, 0, 0.4);
            --eva-red: #ff0033;
            --bg-dark: #07050a;
            --panel-bg: rgba(26, 15, 46, 0.9);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: var(--eva-neon-green);
            background-image: 
                linear-gradient(rgba(122, 31, 162, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(122, 31, 162, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-x: hidden;
        }

        .magi-title {
            font-family: 'Teko', sans-serif;
            text-transform: uppercase;
            letter-spacing: -0.02em;
            line-height: 0.8;
            border-left: 12px solid var(--eva-neon-green);
            padding-left: 15px;
            color: #ffffff;
            text-shadow: 0 0 10px var(--eva-neon-green-glow);
        }

        .mono-font { font-family: 'Share Tech Mono', monospace; }

        .eva-panel {
            background: var(--panel-bg);
            border: 1px solid var(--eva-purple-bright);
            box-shadow: inset 0 0 20px rgba(122, 31, 162, 0.3), 0 0 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .eva-panel::before {
            content: "";
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 4px;
            background: repeating-linear-gradient(90deg, var(--eva-neon-green), var(--eva-neon-green) 10px, transparent 10px, transparent 20px);
        }

        .drop-zone {
            transition: all 0.3s ease;
            background: rgba(122, 31, 162, 0.1);
            border: 2px dashed var(--eva-purple-bright);
        }
        
        .drop-zone.drag-over {
            background-color: rgba(68, 255, 0, 0.1);
            border-color: var(--eva-neon-green);
            box-shadow: 0 0 20px var(--eva-neon-green-glow);
        }

        .scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--eva-purple-bright) transparent;
        }

        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--eva-purple-bright); border-radius: 10px; }

        canvas {
            border: 1px solid var(--eva-neon-green);
            box-shadow: 0 0 8px var(--eva-neon-green-glow);
            width: 100%;
            height: auto;
            display: block;
        }

        .status-badge {
            position: absolute;
            top: 0; left: 0;
            padding: 2px 8px;
            font-family: 'Teko', sans-serif;
            font-size: 12px;
            font-weight: 700;
            z-index: 20;
            text-transform: uppercase;
        }

        .status-success { background: var(--eva-neon-green); color: black; }

        .eva-button {
            background: var(--eva-purple-bright);
            color: white;
            font-family: 'Teko', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s ease;
            clip-path: polygon(0 0, 95% 0, 100% 30%, 100% 100%, 5% 100%, 0 70%);
            border: 1px solid var(--eva-neon-green);
        }

        .eva-button:hover:not(:disabled) {
            background: var(--eva-neon-green);
            color: black;
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--eva-neon-green-glow);
        }

        .eva-button:disabled {
            background: #1a0f2e;
            color: #4b2c6d;
            border-color: #4b2c6d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid var(--eva-purple-bright);
            border-bottom-color: var(--eva-neon-green);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hazard-bar {
            background: repeating-linear-gradient(45deg, var(--eva-neon-green), var(--eva-neon-green) 15px, #000 15px, #000 30px);
            height: 12px;
            width: 100%;
        }

        .item-actions {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 30;
        }

        .preview-container:hover .item-actions { opacity: 1; }

        .action-btn {
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            font-family: 'Share Tech Mono', monospace;
        }

        .btn-dl { background: var(--eva-neon-green); color: black; }
        .btn-rm { background: var(--eva-red); color: white; }

        .opt-btn {
            background: rgba(122, 31, 162, 0.2);
            border: 1px solid var(--eva-purple-bright);
            color: #fff;
            padding: 4px 10px;
            font-size: 11px;
            font-family: 'Teko', sans-serif;
            transition: all 0.2s;
            text-align: center;
            flex: 1;
        }

        .opt-btn.active {
            background: var(--eva-neon-green);
            color: #000;
            border-color: #fff;
        }

        .color-circle {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.3);
            vertical-align: middle;
            margin-right: 4px;
        }

        input[type=range] { accent-color: var(--eva-neon-green); }

        /* Evangelion Style Credits Footer */
        .eva-footer {
            margin-top: 2rem;
            border-top: 1px solid var(--eva-purple-bright);
            padding: 20px 0;
            position: relative;
        }
        
        .eva-credit-tag {
            font-family: 'Teko', sans-serif;
            background: var(--eva-red);
            color: white;
            padding: 2px 15px;
            font-weight: 900;
            text-transform: uppercase;
            display: inline-block;
            clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%);
            letter-spacing: 2px;
        }

        .eva-credit-name {
            font-family: 'Share Tech Mono', monospace;
            color: white;
            border: 1px solid var(--eva-red);
            padding: 1px 10px;
            margin-left: -5px;
            text-transform: uppercase;
            font-size: 14px;
            background: rgba(255, 0, 51, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<div class="hazard-bar"></div>

<div class="max-w-7xl mx-auto px-4 py-6 flex-grow w-full">
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-end mb-6 border-b-2 border-purple-900 pb-4 gap-4">
        <div class="text-left">
            <h1 class="magi-title text-4xl md:text-6xl flex flex-col">
                <span class="text-[10px] tracking-[0.8em] text-green-400 mb-1 opacity-80">MAGI_SYSTEM_V4.3</span>
                <span>UNIT <span class="text-purple-400">01</span>: BIOMETRIC CROPPER</span>
            </h1>
            <p class="mono-font text-[10px] mt-1 tracking-widest text-green-400">
                LCL SYNC: 100% // CROP MODE: AUTO_DETECT // DISTANCE_CALIBRATION_ACTIVE
            </p>
        </div>
    </header>

    <!-- UI Controls -->
    <div class="eva-panel rounded-sm p-4 lg:p-6 mb-6">
        <div id="loadingOverlay" class="flex flex-col items-center justify-center py-6">
            <div class="loader mb-4"></div>
            <span id="status" class="mono-font text-xs tracking-[0.3em] animate-pulse text-green-400">CONNECTING TO LCL CORE...</span>
        </div>

        <div id="mainUI" class="hidden">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Dropzone -->
                <div class="flex-grow">
                    <div id="dropZone" class="drop-zone group p-8 lg:p-12 text-center cursor-pointer relative rounded-lg h-full flex flex-col justify-center">
                        <input type="file" id="upload" accept="image/*" multiple class="hidden">
                        <div class="flex flex-col items-center">
                            <h3 class="mono-font text-xl font-bold mb-2 text-white uppercase">UPLOAD DATA SAMPLES</h3>
                            <p class="mono-font text-[10px] text-purple-300">SERET & LEPAS FILE UNTUK PROSES CROP OTOMATIS</p>
                        </div>
                    </div>
                </div>

                <!-- Settings & Stats -->
                <div class="lg:w-96 flex flex-col gap-4">
                    <!-- Zoom Setting -->
                    <div class="eva-panel p-3 bg-black/40">
                        <label class="mono-font text-[10px] text-green-400 block mb-2 uppercase font-bold italic">Pengaturan Zoom (Jarak Wajah)</label>
                        <input type="range" id="zoomRange" min="0.2" max="0.8" step="0.05" value="0.45" class="w-full h-2 rounded-lg cursor-pointer bg-purple-900 mb-1">
                        <div class="flex justify-between mono-font text-[8px] text-purple-400">
                            <span>JAUH</span>
                            <span>DEKAT</span>
                        </div>
                    </div>

                    <!-- Size Setting -->
                    <div class="eva-panel p-3 bg-black/40">
                        <label class="mono-font text-[10px] text-green-400 block mb-2 uppercase font-bold">Ukuran Target</label>
                        <div class="flex gap-2" id="ratioContainer">
                            <button class="opt-btn active" data-type="ratio" data-w="600" data-h="800" data-label="3x4">3x4</button>
                            <button class="opt-btn" data-type="ratio" data-w="400" data-h="600" data-label="2x3">2x3</button>
                            <button class="opt-btn" data-type="ratio" data-w="800" data-h="1200" data-label="4x6">4x6</button>
                        </div>
                    </div>

                    <!-- Background Setting -->
                    <div class="eva-panel p-3 bg-black/40">
                        <label class="mono-font text-[10px] text-green-400 block mb-2 uppercase font-bold italic">Latar Belakang (Background Fill)</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button class="opt-btn active" data-type="bg" data-val="auto">
                                <span class="color-circle" style="background: linear-gradient(45deg, #ff0, #f0f, #0ff)"></span> AUTO MATCH
                            </button>
                            <button class="opt-btn" data-type="bg" data-val="#ff0000">
                                <span class="color-circle" style="background: #ff0000"></span> MERAH
                            </button>
                            <button class="opt-btn" data-type="bg" data-val="#0000ff">
                                <span class="color-circle" style="background: #0000ff"></span> BIRU
                            </button>
                            <button class="opt-btn" data-type="bg" data-val="#00ff00">
                                <span class="color-circle" style="background: #00ff00"></span> HIJAU
                            </button>
                            <button class="opt-btn" data-type="bg" data-val="#ffffff">
                                <span class="color-circle" style="background: #ffffff"></span> PUTIH
                            </button>
                            <button class="opt-btn" data-type="bg" data-val="#000000">
                                <span class="color-circle" style="background: #000000"></span> HITAM
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-2 mono-font text-center">
                        <div class="bg-purple-900/40 border border-purple-500/40 p-2">
                            <span class="text-[8px] uppercase block">Total</span>
                            <span id="totalCount" class="text-xl font-bold text-white">0</span>
                        </div>
                        <div class="bg-green-950/20 border border-green-500/40 p-2">
                            <span class="text-[8px] uppercase block text-green-400">Valid</span>
                            <span id="successCount" class="text-xl font-bold text-green-400">0</span>
                        </div>
                        <div class="bg-red-950/20 border border-red-500/40 p-2">
                            <span class="text-[8px] uppercase block text-red-500">Gagal</span>
                            <span id="failCount" class="text-xl font-bold text-red-500">0</span>
                        </div>
                    </div>

                    <button id="downloadZip" disabled class="eva-button w-full py-4 text-xl">
                        EXTRACT_ALL_BATCH.ZIP
                    </button>
                    <button id="btnClear" class="w-full py-1 mono-font text-[9px] border border-red-900/40 text-red-400 hover:bg-red-900/20 uppercase transition-colors">
                        Eject (Hapus Semua)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-9">
            <div class="bg-purple-800 text-white px-3 py-1 text-[10px] font-black tracking-widest uppercase flex justify-between items-center mb-2">
                <span>Output View: Tervalidasi</span>
                <span id="activeRatioLabel" class="text-green-400">[Target: 3x4]</span>
            </div>
            <div class="scroll-container bg-black/40 border border-purple-900/30 p-4 rounded-sm">
                <div id="previewSuccess" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <div id="emptyState" class="col-span-full py-32 flex flex-col items-center justify-center opacity-30 mono-font text-purple-400">
                        <div class="text-[12px] tracking-[0.4em]">MENUNGGU DATA INPUT...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-3">
            <div class="bg-red-900 text-white px-3 py-1 text-[10px] font-black tracking-widest uppercase mb-2">Error Log</div>
            <div class="scroll-container bg-red-950/10 border border-red-900/20 p-3 rounded-sm">
                <div id="previewFail" class="space-y-3"></div>
                <div id="noFailState" class="py-10 text-center opacity-20 mono-font text-[8px] text-red-400">STATUS NORMAL</div>
            </div>
        </div>
    </div>

    <!-- Footer Credits -->
    <footer class="eva-footer flex flex-col items-center">
        <div class="flex items-center mb-4">
            <div class="eva-credit-tag">Credit By</div>
            <div class="eva-credit-name">Derry</div>
        </div>
        <div class="mono-font text-[8px] text-purple-400 tracking-[0.5em] opacity-40 uppercase">
            Human Instrumentality Project // NERV-HQ 01
        </div>
    </footer>
</div>

<div class="hazard-bar mt-6"></div>

<script>
    const upload = document.getElementById('upload');
    const dropZone = document.getElementById('dropZone');
    const previewSuccess = document.getElementById('previewSuccess');
    const previewFail = document.getElementById('previewFail');
    const statusText = document.getElementById('status');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const mainUI = document.getElementById('mainUI');
    const btnZip = document.getElementById('downloadZip');
    const btnClear = document.getElementById('btnClear');
    const emptyState = document.getElementById('emptyState');
    const noFailState = document.getElementById('noFailState');
    const activeRatioLabel = document.getElementById('activeRatioLabel');
    const zoomRange = document.getElementById('zoomRange');
    
    const totalCountDisp = document.getElementById('totalCount');
    const successCountDisp = document.getElementById('successCount');
    const failCountDisp = document.getElementById('failCount');
    
    let currentConfig = { w: 600, h: 800, label: '3x4' };
    let bgMode = 'auto'; // 'auto' or solid hex
    let croppedImages = [];
    let successCount = 0;
    let failCount = 0;
    let uploadedFiles = []; 

    // Initialize AI
    async function initAI() {
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            loadingOverlay.classList.add('hidden');
            mainUI.classList.remove('hidden');
        } catch (err) {
            statusText.innerText = "CRITICAL: AI CORE OFFLINE";
        }
    }

    // Settings Change Listeners
    document.querySelectorAll('.opt-btn').forEach(btn => {
        btn.onclick = () => {
            const type = btn.dataset.type;
            document.querySelectorAll(`.opt-btn[data-type="${type}"]`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (type === 'ratio') {
                currentConfig = {
                    w: parseInt(btn.dataset.w),
                    h: parseInt(btn.dataset.h),
                    label: btn.dataset.label
                };
                activeRatioLabel.innerText = `[Target: ${currentConfig.label}]`;
            } else if (type === 'bg') {
                bgMode = btn.dataset.val;
            }
            reprocessAll();
        };
    });

    zoomRange.onchange = () => reprocessAll();

    // Interaction Handlers
    dropZone.onclick = () => upload.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
    dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    };
    upload.onchange = (e) => handleFiles(e.target.files);

    btnClear.onclick = () => {
        previewSuccess.innerHTML = '';
        previewSuccess.appendChild(emptyState);
        previewFail.innerHTML = '';
        noFailState.style.display = 'block';
        croppedImages = [];
        uploadedFiles = [];
        successCount = 0;
        failCount = 0;
        updateStats();
        btnZip.disabled = true;
        upload.value = '';
        emptyState.style.display = 'flex';
    };

    async function reprocessAll() {
        if (uploadedFiles.length === 0) return;
        const currentFiles = [...uploadedFiles];
        previewSuccess.innerHTML = '';
        previewSuccess.appendChild(emptyState);
        previewFail.innerHTML = '';
        noFailState.style.display = 'block';
        croppedImages = [];
        successCount = 0;
        failCount = 0;
        handleFiles(currentFiles, true);
    }

    async function handleFiles(files, isReprocessing = false) {
        if (!files.length) return;
        emptyState.style.display = 'none';
        
        if (!isReprocessing) {
            for (let f of files) {
                if (!uploadedFiles.some(existing => existing.name === f.name && existing.size === f.size)) {
                    uploadedFiles.push(f);
                }
            }
        }
        
        const filesToProcess = isReprocessing ? files : Array.from(files);

        for (let file of filesToProcess) {
            if (!file.type.startsWith('image/')) continue;
            
            const fileId = crypto.randomUUID();
            try {
                const img = await faceapi.bufferToImage(file);
                let detections = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.15 }));
                
                if (detections.length === 0) {
                    detections = await faceapi.detectAllFaces(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.1 }));
                }

                if (detections.length > 0) {
                    const face = detections.sort((a, b) => b.box.width - a.box.width)[0].box;
                    const canvas = processImage(img, face);
                    const base64 = canvas.toDataURL('image/jpeg', 0.92);
                    const finalName = file.name;

                    const container = document.createElement('div');
                    container.id = `item-${fileId}`;
                    container.className = "preview-container flex flex-col group relative";
                    container.innerHTML = `
                        <div class="relative overflow-hidden border border-purple-500/30 rounded-sm">
                            <span class="status-badge status-success">OK</span>
                            <div class="item-actions">
                                <button class="action-btn btn-dl" onclick="downloadSingle('${base64}', '${finalName}')">DL</button>
                                <button class="action-btn btn-rm" onclick="removeItem('${fileId}', 'success', '${file.name}')">X</button>
                            </div>
                        </div>
                        <span class="mono-font text-[7px] text-purple-400 mt-1 truncate px-1 opacity-70">${file.name}</span>
                    `;
                    container.querySelector('.relative').prepend(canvas);
                    
                    successCount++;
                    croppedImages.push({ id: fileId, name: finalName, data: base64 });
                    previewSuccess.appendChild(container);
                } else {
                    throw new Error("Face not detected");
                }
            } catch (err) {
                noFailState.style.display = 'none';
                failCount++;
                const failItem = document.createElement('div');
                failItem.id = `item-${fileId}`;
                failItem.className = "bg-red-950/20 border border-red-500/30 p-2 rounded-sm flex items-center justify-between";
                failItem.innerHTML = `
                    <div class="flex flex-col">
                        <span class="mono-font text-[9px] text-red-500 font-bold uppercase italic">NO_DETECTION</span>
                        <span class="mono-font text-[7px] text-red-400/60 truncate w-24">${file.name}</span>
                    </div>
                    <button class="action-btn btn-rm" onclick="removeItem('${fileId}', 'fail', '${file.name}')">X</button>
                `;
                previewFail.appendChild(failItem);
            }
            updateStats();
        }
        btnZip.disabled = croppedImages.length === 0;
    }

    function getAverageColor(img, x, y, size) {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = size;
        tempCanvas.height = size;
        const tempCtx = tempCanvas.getContext('2d');
        const safeX = Math.max(0, Math.min(x, img.width - size));
        const safeY = Math.max(0, Math.min(y, img.height - size));
        tempCtx.drawImage(img, safeX, safeY, size, size, 0, 0, size, size);
        const data = tempCtx.getImageData(0, 0, size, size).data;
        let r = 0, g = 0, b = 0;
        for (let i = 0; i < data.length; i += 4) {
            r += data[i]; g += data[i+1]; b += data[i+2];
        }
        const pixels = data.length / 4;
        return `rgb(${Math.round(r/pixels)}, ${Math.round(g/pixels)}, ${Math.round(b/pixels)})`;
    }

    function processImage(img, face) {
        const canvas = document.createElement('canvas');
        canvas.width = currentConfig.w;
        canvas.height = currentConfig.h;
        const ctx = canvas.getContext('2d');

        // Logic Background
        let fillColor = bgMode === 'auto' ? getAverageColor(img, 10, 10, 20) : bgMode;

        const faceHeightRatio = parseFloat(zoomRange.value); 
        const scale = (canvas.height * faceHeightRatio) / face.height;
        const cropWidth = canvas.width / scale;
        const cropHeight = canvas.height / scale;
        const centerX = face.x + (face.width / 2);
        const centerY = face.y + (face.height * 0.45); 
        const srcX = centerX - (cropWidth / 2);
        const srcY = centerY - (cropHeight / 2);

        // Fill background first
        ctx.fillStyle = fillColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, srcX, srcY, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);

        return canvas;
    }

    function downloadSingle(data, filename) {
        const link = document.createElement('a');
        link.href = data;
        link.download = filename;
        link.click();
    }

    function removeItem(id, type, originalName) {
        document.getElementById(`item-${id}`)?.remove();
        uploadedFiles = uploadedFiles.filter(f => f.name !== originalName);
        if (type === 'success') {
            croppedImages = croppedImages.filter(img => img.id !== id);
            successCount--;
            if (previewSuccess.querySelectorAll('.preview-container').length === 0) {
                emptyState.style.display = 'flex';
            }
        } else {
            failCount--;
            if (previewFail.children.length === 0) {
                noFailState.style.display = 'block';
            }
        }
        updateStats();
        btnZip.disabled = croppedImages.length === 0;
    }

    function updateStats() {
        totalCountDisp.innerText = successCount + failCount;
        successCountDisp.innerText = successCount;
        failCountDisp.innerText = failCount;
    }

    btnZip.onclick = async () => {
        if (!croppedImages.length) return;
        const zip = new JSZip();
        croppedImages.forEach(img => zip.file(img.name, img.data.split(',')[1], {base64: true}));
        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `BATCH_NERV_EXPORT_${Date.now()}.zip`;
        link.click();
    };

    window.onload = initAI;
</script>

</body>
</html>